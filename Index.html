import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, arrayUnion, updateDoc } from 'firebase/firestore';
import { 
  Wand2, Download, Plus, Copy, Check, 
  RefreshCcw, Sparkles, Box, Database, Palette, 
  LayoutTemplate, History, ChevronRight,
  Zap, Menu, X, Smartphone, Monitor, Layers,
  Terminal, ShieldCheck, Cpu, Trash2
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'aether-ultra-final';

const DEFAULT_ICONS = [
  { key: 'home', label: 'Home' },
  { key: 'search', label: 'Search' },
  { key: 'settings', label: 'Settings' },
  { key: 'user', label: 'User' },
  { key: 'bell', label: 'Alerts' }
];

const App = () => {
  const [user, setUser] = useState(null);
  const [prompt, setPrompt] = useState('Futuristic Glassmorphism with internal refractions');
  const [isGenerating, setIsGenerating] = useState(false);
  const [customIcons, setCustomIcons] = useState([]);
  const [iconPack, setIconPack] = useState(null);
  const [styleLogic, setStyleLogic] = useState('');
  const [copyStatus, setCopyStatus] = useState(null);
  const [newIconLabel, setNewIconLabel] = useState('');
  const [viewMode, setViewMode] = useState('grid'); 
  const [accentColor, setAccentColor] = useState('#818cf8');
  const [history, setHistory] = useState([]);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  // 1. Auth Initializer
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Data Synchronization
  useEffect(() => {
    if (!user) return;
    const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'iconConfig');
    const unsubConfig = onSnapshot(configRef, (doc) => {
      if (doc.exists()) {
        setCustomIcons(doc.data().customIcons || []);
      } else {
        setDoc(configRef, { customIcons: [] });
      }
    });

    const historyRef = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
    const unsubHistory = onSnapshot(historyRef, (snapshot) => {
      const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      setHistory(docs.sort((a, b) => b.timestamp - a.timestamp).slice(0, 8));
    });

    return () => { unsubConfig(); unsubHistory(); };
  }, [user]);

  const allIconTypes = useMemo(() => [...DEFAULT_ICONS, ...customIcons], [customIcons]);

  // Add Custom Icon Type
  const addIconType = async () => {
    if (!newIconLabel.trim() || !user) return;
    const key = newIconLabel.toLowerCase().replace(/\s+/g, '_');
    if (allIconTypes.some(i => i.key === key)) return;

    const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'iconConfig');
    const newItem = { key, label: newIconLabel };
    
    try {
      await updateDoc(configRef, {
        customIcons: arrayUnion(newItem)
      });
      setNewIconLabel('');
    } catch (e) {
      console.error("Error adding icon type", e);
    }
  };

  const removeIconType = async (key) => {
    if (!user) return;
    const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'iconConfig');
    const updated = customIcons.filter(i => i.key !== key);
    await setDoc(configRef, { customIcons: updated });
  };

  // 3. Ultra Generation Logic
  const generateSystem = async () => {
    if (!prompt.trim()) return;
    setIsGenerating(true);
    setIsSidebarOpen(false);
    const apiKey = ""; 

    const systemPrompt = `You are the High-End Visual Architect "Aether-Core".
    AESTHETIC: "${prompt}"
    
    MANDATE:
    1. AVOID GENERIC PATHS. Create bespoke, professional geometric art.
    2. USE ADVANCED SVG: Utilize <defs>, gradients, filters, and multi-layered paths.
    3. VOLUMETRIC DESIGN: If the style is 3D or Glass, use overlapping shapes with varying opacities.
    4. STRUCTURAL UNITY: All icons MUST share identical stroke-widths, corner radii, and lighting.
    
    REQUIRED KEYS: ${allIconTypes.map(i => i.key).join(', ')}.
    
    OUTPUT JSON:
    {
      "color": "#HEX",
      "style_logic": "Brief professional explanation of architectural choices.",
      "icons": { ${allIconTypes.map(i => `"${i.key}": "SVG_CODE"`).join(', ')} }
    }`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Architectural Synthesis: ${prompt}` }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const data = await response.json();
      const result = JSON.parse(data.candidates[0].content.parts[0].text);
      setIconPack(result.icons);
      setAccentColor(result.color || '#818cf8');
      setStyleLogic(result.style_logic || '');
      
      if (user) {
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'history', Date.now().toString()), {
          pack: result.icons,
          prompt,
          color: result.color,
          logic: result.style_logic,
          timestamp: Date.now()
        });
      }
    } catch (e) {
      console.error(e);
    } finally { setIsGenerating(false); }
  };

  const copyToClipboard = (svg, key) => {
    const el = document.createElement('textarea');
    el.value = svg;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setCopyStatus(key);
    setTimeout(() => setCopyStatus(null), 2000);
  };

  return (
    <div className="min-h-screen bg-[#030305] text-slate-300 font-sans flex flex-col overflow-hidden">
      {/* Background Aura */}
      <div 
        className="fixed inset-0 opacity-20 pointer-events-none transition-all duration-1000"
        style={{ background: `radial-gradient(circle at 50% -10%, ${accentColor}44, transparent 70%)` }}
      />

      {/* HEADER */}
      <header className="relative z-50 h-16 md:h-20 bg-black/60 backdrop-blur-2xl border-b border-white/5 px-4 md:px-8 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="lg:hidden p-2 text-slate-500">
            {isSidebarOpen ? <X /> : <Menu />}
          </button>
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-white to-slate-400 flex items-center justify-center">
               <Cpu size={20} className="text-black" />
            </div>
            <h1 className="text-xl font-black text-white italic tracking-tighter uppercase hidden sm:block">Aether<span style={{ color: accentColor }}>Ultra</span></h1>
          </div>
        </div>

        <div className="hidden lg:flex flex-1 max-w-3xl mx-12">
          <div className="flex w-full bg-white/5 border border-white/10 rounded-2xl overflow-hidden focus-within:ring-2 ring-white/10 transition-all">
            <div className="flex items-center pl-5 text-slate-500"><Terminal size={18} /></div>
            <input 
              type="text" value={prompt} onChange={e => setPrompt(e.target.value)}
              className="flex-1 bg-transparent px-5 py-4 text-sm focus:outline-none text-white font-medium"
              placeholder="Inject design aesthetic..."
            />
            <button 
              onClick={generateSystem} disabled={isGenerating}
              className="px-10 bg-white text-black text-[11px] font-black uppercase tracking-[0.2em] hover:bg-slate-200 transition-all disabled:opacity-50"
            >
              {isGenerating ? 'Synthesizing' : 'Synthesize'}
            </button>
          </div>
        </div>

        <button onClick={() => setViewMode(v => v === 'grid' ? 'blueprint' : 'grid')} className="p-3 bg-white/5 border border-white/10 rounded-xl text-slate-400">
          {viewMode === 'grid' ? <LayoutTemplate size={20} /> : <Box size={20} />}
        </button>
      </header>

      <div className="flex-1 flex overflow-hidden relative">
        {/* SIDEBAR */}
        <aside className={`
          absolute lg:relative z-40 w-80 h-full bg-[#08080a] border-r border-white/5 transition-transform duration-300
          ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        `}>
          <div className="flex flex-col h-full p-6 space-y-8 overflow-y-auto custom-scrollbar">
            {/* Mobile Controls */}
            <div className="lg:hidden space-y-4">
               <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Directive</label>
               <textarea 
                value={prompt} onChange={e => setPrompt(e.target.value)}
                className="w-full bg-black/40 border border-white/10 rounded-xl p-4 text-xs min-h-[100px] outline-none"
                placeholder="Style description..."
               />
               <button onClick={generateSystem} disabled={isGenerating} className="w-full py-4 bg-white text-black rounded-xl font-black text-[10px] uppercase tracking-widest">
                 {isGenerating ? 'Synthesizing...' : 'Execute Synthesis'}
               </button>
            </div>

            {styleLogic && (
              <div className="p-5 bg-white/[0.03] border border-white/5 rounded-2xl">
                 <div className="flex items-center gap-2 text-indigo-400 mb-2">
                    <ShieldCheck size={14} />
                    <span className="text-[10px] font-black uppercase tracking-widest">Logic Audit</span>
                 </div>
                 <p className="text-[11px] text-slate-400 leading-relaxed italic">"{styleLogic}"</p>
              </div>
            )}

            <section>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Schema / Icon Types</h2>
              </div>
              
              {/* Add New Icon Type UI */}
              <div className="flex gap-2 mb-4">
                <input 
                  type="text" value={newIconLabel} onChange={e => setNewIconLabel(e.target.value)}
                  placeholder="New Icon Name"
                  className="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-[11px] outline-none focus:border-white/20"
                />
                <button onClick={addIconType} className="p-2 bg-indigo-500/20 text-indigo-400 border border-indigo-500/20 rounded-xl hover:bg-indigo-500/30">
                  <Plus size={16} />
                </button>
              </div>

              <div className="space-y-2">
                {allIconTypes.map(icon => (
                  <div key={icon.key} className="p-3 bg-white/[0.02] border border-white/5 rounded-xl flex justify-between items-center group">
                    <div className="flex flex-col">
                      <span className="text-xs font-bold text-slate-300">{icon.label}</span>
                      <span className="text-[9px] font-mono text-slate-600 uppercase tracking-tighter">{icon.key}</span>
                    </div>
                    {!DEFAULT_ICONS.some(d => d.key === icon.key) && (
                      <button onClick={() => removeIconType(icon.key)} className="opacity-0 group-hover:opacity-100 p-1.5 text-slate-600 hover:text-red-400 transition-all">
                        <Trash2 size={12} />
                      </button>
                    )}
                  </div>
                ))}
              </div>
            </section>

            <section className="flex-1">
              <h2 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Archives</h2>
              <div className="space-y-2">
                {history.map(item => (
                  <button 
                    key={item.id} 
                    onClick={() => { setIconPack(item.pack); setPrompt(item.prompt); setAccentColor(item.color); setStyleLogic(item.logic); setIsSidebarOpen(false); }} 
                    className="w-full text-left p-4 rounded-xl border border-white/5 hover:border-white/20 bg-white/[0.01] transition-all group"
                  >
                    <div className="text-[11px] font-bold text-slate-400 truncate mb-1 group-hover:text-white">{item.prompt}</div>
                    <div className="text-[9px] text-slate-600 font-mono">{new Date(item.timestamp).toLocaleDateString()}</div>
                  </button>
                ))}
              </div>
            </section>
          </div>
        </aside>

        {/* WORKSPACE */}
        <main className="flex-1 overflow-y-auto p-4 md:p-12 bg-[radial-gradient(#ffffff04_1px,transparent_1px)] [background-size:40px_40px]">
          {iconPack ? (
            <div className={`grid gap-6 md:gap-10 ${viewMode === 'grid' ? 'grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5' : 'grid-cols-1'}`}>
              {Object.entries(iconPack).map(([key, svg]) => (
                <div key={key} className={`group bg-[#0a0a0c] border border-white/5 rounded-[2.5rem] p-6 md:p-10 flex flex-col items-center hover:bg-[#0e0e11] transition-all ${viewMode === 'blueprint' ? 'flex-row gap-12' : ''}`}>
                  <div className={`relative flex items-center justify-center bg-black/40 border border-white/5 rounded-[2rem] overflow-hidden ${viewMode === 'blueprint' ? 'w-56 h-56 shrink-0' : 'w-full aspect-square mb-8'}`}>
                    <div 
                      className="w-full h-full p-[20%] transition-transform duration-700 group-hover:scale-110"
                      dangerouslySetInnerHTML={{ __html: svg }}
                      style={{ color: accentColor }}
                    />
                  </div>
                  <div className="w-full flex-1">
                    <div className="flex justify-between items-center mb-5">
                      <span className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] truncate">
                        {allIconTypes.find(i => i.key === key)?.label || key}
                      </span>
                      <button onClick={() => copyToClipboard(svg, key)} className="p-2.5 bg-white/5 hover:bg-white/10 rounded-xl text-slate-400 hover:text-white">
                        {copyStatus === key ? <Check size={16} className="text-green-500" /> : <Copy size={16} />}
                      </button>
                    </div>
                    {viewMode === 'blueprint' && (
                      <div className="font-mono text-[10px] text-slate-500 bg-black/60 p-5 rounded-2xl border border-white/5 break-all h-40 overflow-y-auto custom-scrollbar">
                        {svg}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="h-full flex flex-col items-center justify-center opacity-40">
               <Cpu size={64} className="mb-6 animate-pulse" />
               <p className="text-[10px] font-black uppercase tracking-[0.3em]">Core Engine Ready</p>
               <p className="text-[9px] mt-2 text-slate-600">Waiting for synthesis directive...</p>
            </div>
          )}
        </main>

        {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="lg:hidden fixed inset-0 z-30 bg-black/80 backdrop-blur-md" />}
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
      `}} />
    </div>
  );
};

export default App;

      
